---
import { siteConfig } from "@/config/site";

const navLinks = siteConfig.navLinks;
---

<header
    id="main-header"
    class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 border-b border-black/10 bg-white/90 backdrop-blur-md"
>
    <div
        class="w-full flex justify-between items-stretch h-16 md:h-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 border-x border-black/10"
    >
        {/* Logo Section */}
        <div class="flex items-center pr-6 md:pr-8 border-r border-black/10">
            <a
                href="/"
                class="flex items-center gap-2"
                aria-label="Go to Homepage"
            >
                <img
                    src="/images/logo.png"
                    alt={siteConfig.name}
                    class="h-8 w-auto object-contain"
                />
            </a>
        </div>

        {/* Desktop Nav */}
        <nav class="hidden md:flex items-stretch ml-auto">
            {
                navLinks.map((link) => (
                    <a
                        href={link.href}
                        class="flex items-center px-8 border-l border-black/10 text-sm font-medium uppercase tracking-wide hover:bg-black hover:text-white transition-colors duration-200 group relative overflow-hidden"
                    >
                        <span class="relative z-10">{link.name}</span>
                    </a>
                ))
            }
            <a
                href="/#contact"
                class="flex items-center px-8 border-l border-black/10 bg-black text-white text-sm font-medium uppercase tracking-wide hover:bg-gray-100 hover:text-black transition-colors duration-300"
            >
                Let's Talk
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="ml-2 w-4 h-4"
                    ><line x1="7" y1="17" x2="17" y2="7"></line><polyline
                        points="7 7 17 7 17 17"></polyline></svg
                >
            </a>
        </nav>

        {/* Mobile Menu Button - Hidden when Dock is used */}
        <button
            id="mobile-menu-open"
            class="hidden items-center justify-center px-6 border-l border-black/10 ml-auto"
            aria-label="Open Menu"
            aria-expanded="false"
            aria-controls="mobile-menu-overlay"
            aria-haspopup="dialog"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-6 h-6"
                ><line x1="4" x2="20" y1="12" y2="12"></line><line
                    x1="4"
                    x2="20"
                    y1="6"
                    y2="6"></line><line x1="4" x2="20" y1="18" y2="18"
                ></line></svg
            >
        </button>
    </div>
</header>

{/* Mobile Menu Overlay */}
<div
    id="mobile-menu-overlay"
    class="fixed inset-0 z-[60] bg-white flex flex-col translate-y-[-100%] transition-transform duration-500 [transition-timing-function:cubic-bezier(0.19,1,0.22,1)]"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
    aria-labelledby="mobile-menu-title"
    inert
>
    <div class="flex justify-between items-center p-6 border-b border-black/10">
        <span
            id="mobile-menu-title"
            class="font-display font-bold text-2xl uppercase">Menu</span
        >
        <button id="mobile-menu-close" aria-label="Close Menu">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-8 h-8"
                ><line x1="18" y1="6" x2="6" y2="18"></line><line
                    x1="6"
                    y1="6"
                    x2="18"
                    y2="18"></line></svg
            >
        </button>
    </div>
    <div class="flex flex-col p-6 space-y-6">
        {
            navLinks.map((link) => (
                <a
                    href={link.href}
                    class="mobile-nav-link font-display text-4xl md:text-6xl font-light uppercase hover:text-gray-500 transition-colors"
                >
                    {link.name}
                </a>
            ))
        }
        <a
            href="/#contact"
            class="mobile-nav-link mt-8 inline-flex items-center justify-between w-full py-4 border-t border-b border-black font-display text-xl uppercase font-bold"
        >
            Let's Talk
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-6 h-6"
                ><line x1="7" y1="17" x2="17" y2="7"></line><polyline
                    points="7 7 17 7 17 17"></polyline></svg
            >
        </a>
    </div>
</div>

<script>
    const header = document.getElementById("main-header");
    const mobileMenuOpen = document.getElementById(
        "mobile-menu-open",
    ) as HTMLButtonElement | null;
    const mobileMenuClose = document.getElementById(
        "mobile-menu-close",
    ) as HTMLButtonElement | null;
    const mobileMenuOverlay = document.getElementById(
        "mobile-menu-overlay",
    ) as HTMLElement | null;
    const mobileNavLinks = document.querySelectorAll(
        ".mobile-nav-link",
    ) as NodeListOf<HTMLElement>;
    const mainContent = document.querySelector("main") as HTMLElement | null;
    const footers = document.querySelectorAll(
        "footer, .md\\:block > footer",
    ) as NodeListOf<HTMLElement>;

    // Scroll Logic
    window.addEventListener("scroll", () => {
        if (window.scrollY > 50) {
            header?.classList.add("shadow-sm");
        } else {
            header?.classList.remove("shadow-sm");
        }
    });

    /**
     * @param {boolean} active
     */
    function toggleBackgroundInert(active: boolean) {
        if (mainContent) {
            if (active) mainContent.setAttribute("inert", "");
            else mainContent.removeAttribute("inert");
        }
        if (header) {
            if (active) header.setAttribute("inert", "");
            else header.removeAttribute("inert");
        }
        footers.forEach((footer) => {
            if (active) footer.setAttribute("inert", "");
            else footer.removeAttribute("inert");
        });
    }

    // Mobile Menu Toggle
    function openMenu() {
        mobileMenuOverlay?.classList.remove("translate-y-[-100%]");
        mobileMenuOverlay?.classList.add("translate-y-0");
        mobileMenuOpen?.setAttribute("aria-expanded", "true");
        mobileMenuOverlay?.setAttribute("aria-hidden", "false");
        mobileMenuOverlay?.removeAttribute("inert");

        toggleBackgroundInert(true);
        document.body.style.overflow = "hidden";

        // Focus search first link if available, otherwise close button
        const firstLink = mobileNavLinks[0];
        if (firstLink instanceof HTMLElement) {
            firstLink.focus();
        } else {
            mobileMenuClose?.focus();
        }
    }

    function isMenuOpen() {
        return mobileMenuOverlay?.classList.contains("translate-y-0") ?? false;
    }

    function closeMenu(restoreFocus = true) {
        mobileMenuOverlay?.classList.remove("translate-y-0");
        mobileMenuOverlay?.classList.add("translate-y-[-100%]");
        mobileMenuOpen?.setAttribute("aria-expanded", "false");
        mobileMenuOverlay?.setAttribute("aria-hidden", "true");
        mobileMenuOverlay?.setAttribute("inert", "");

        toggleBackgroundInert(false);
        document.body.style.overflow = "";

        if (restoreFocus) {
            mobileMenuOpen?.focus();
        }
    }

    /**
     * @param {KeyboardEvent} event
     */
    function onKeyDown(event: KeyboardEvent) {
        if (event.key === "Escape" && isMenuOpen()) {
            closeMenu();
        }

        // Manual focus trap fallback for browsers that don't support 'inert' well
        if (event.key === "Tab" && isMenuOpen() && mobileMenuOverlay) {
            const focusableElements = mobileMenuOverlay.querySelectorAll(
                'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])',
            ) as NodeListOf<HTMLElement>;
            const first = focusableElements[0];
            const last = focusableElements[focusableElements.length - 1];

            if (event.shiftKey) {
                if (
                    document.activeElement === first &&
                    last instanceof HTMLElement
                ) {
                    event.preventDefault();
                    last.focus();
                }
            } else {
                if (
                    document.activeElement === last &&
                    first instanceof HTMLElement
                ) {
                    event.preventDefault();
                    first.focus();
                }
            }
        }
    }

    mobileMenuOpen?.addEventListener("click", openMenu);
    mobileMenuClose?.addEventListener("click", () => closeMenu());
    document.addEventListener("keydown", (e) => onKeyDown(e as KeyboardEvent));

    // Close menu when clicking backdrop area
    mobileMenuOverlay?.addEventListener("click", (e) => {
        if (e.target === mobileMenuOverlay) {
            closeMenu();
        }
    });

    mobileNavLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
            const target = event.currentTarget as HTMLElement;
            const href =
                target instanceof HTMLAnchorElement
                    ? target.getAttribute("href")
                    : null;

            closeMenu(false);

            if (href?.includes("#")) {
                const hash = href.substring(href.indexOf("#"));
                // Only run focus logic if the destination exists on the current page
                const destination = document.querySelector(hash);
                if (destination instanceof HTMLElement) {
                    destination.setAttribute("tabindex", "-1");
                    destination.focus({ preventScroll: true });
                }
            }
        });
    });
</script>
